open Test_utils
open Bignum

let test_bignum256 () =
  let test_result = test_result "Bignum256" in

  let buf = Bytes.of_string "\x01\x02\x03" in
  let bn = Bignum256.from_bytes_pad ~buf in
  let res = Bignum256.to_bytes_unpad ~bn in
  if res = buf then
    test_result Success ""
  else
    test_result Failure ""

let test_bignum4096 () =
  let test_result = test_result "Bignum4096" in

  (* from tests/bignum4096_vectors.h *)
  let test1_nBytes = Bytes.of_string
      "\xf6\x01\xbe\x0d\xcc\xd0\x4a\xa4\x0b\x12\xf3\xf1\x91\xae\x17\xc1\xf9\xc8\xc0\xb6\x8e\x7a\x77\xe1\x4b\xe2\x5c\x3c\x79\x07\xcb\x1d\x33\xa6\xef\x41\x8e\xf4\x18\x52\xf3\x2c\x98\x39\x2b\xc5\xc9\xae\xd9\x1c\x1a\x15\x01\xc5\x03\xea\xb8\x9b\x3e\xe6\xf4\xf8\xeb\x2e\x0f\xcf\xc4\x1b\xd0\x36\x09\xcf\x6a\x8e\xb3\xaa\x6f\x0f\xbe\x23\x18\x7b\x33\xdb\x4d\x34\xb6\x6d\x12\x8a\x8a\xba\x0a\x2a\xbf\x40\xbb\x9d\x13\xd8\xe2\x55\x45\x69\xa5\x7a\xb1\xd8\xc6\x1b\x8c\xad\x2d\xc8\x85\x99\xae\x0d\xa5\x34\x6e\x15\xda\xce\x1b\xac\x7b\xf6\x97\x37\xc2\x2f\x08\x3b\xe9\xb4\x6b\xb8\xb1\xea\xb5\x95\x7b\x2d\xa7\x40\x27\x5e\x96\xc8\x71\x95\xb9\x6f\xe1\x14\x52\x15\x9d\xaf\xcf\xd9\x16\xce\xe5\xd7\x49\xa7\x7b\xc3\x90\x5a\x5e\xbd\x38\x7a\xe4\x45\xe8\xfe\x70\xf1\x6e\x9a\x08\x66\x39\x77\x9c\xef\xfb\xfd\x41\x55\x7b\xd9\x9a\xea\x6a\x37\x1a\x6b\x4b\x16\x06\x15\xa1\xa1\x2b\xc6\x95\x8d\x34\xbc\xe0\xc8\x5a\xdc\xbd\x83\x92\xfa\x10\xce\xca\x52\x20\x9d\x56\x19\x6b\xa3\xd2\x73\xce\x22\x8f\x1f\x11\x11\x92\xaa\x92\xde\x2a\x03\x97\x98\xa1\x7b\xce\xcb\x4d\xc6\x10\x0e\x6f\x8a\xe8\xc2\x64\x3f\x2a\xe7\x68\xb2\x25\x5f\x08\x2c\x97\x8e\x95\xca\x55\x15\x55\xf1\x06\x08\x23\x1c\xf8\x00\x3b\xbf\x80\x79\x69\xff\xf1\xe5\x19\x14\xb9\xa8\xc9\xb8\xf4\x56\x46\x45\xb9\xe5\xd7\x05\xff\xad\x29\x66\x3f\x5d\xae\x3d\x76\x65\x2b\x42\x2e\x43\xf1\x3e\x6c\x14\x91\x09\x08\x05\xc2\xd1\x26\x8a\x74\xa2\x51\x17\x74\x27\xe3\x3a\x9a\x91\x17\x5c\x36\x70\xb9\x17\x46\x00\x8b\xce\x1f\xd2\x31\xe6\xe4\xf2\xad\x70\xcb\x43\xac\xa5\xf0\x76\x00\xa6\xd3\x1d\xd0\x29\x15\x24\x3d\xfd\xd9\x43\xa0\x21\x65\xda\x36\x7a\x6b\x7e\x4d\xae\x1d\xd2\xe8\xb8\x36\x90\x30\x80\x79\x5d\x25\x85\x07\x6c\xc1\xc1\x5d\xd9\xe8\xd2\xe5\xe0\x47\x52\x65\x69\xb1\xbf\xd3\x95\xd9\x57\xeb\x9f\xde\x32\x5d\x34\x2d\x14\x42\x6e\x71\xef\xdc\x18\x87\x51\x5e\x53\xcd\xea\x58\x34\x92\x1f\x92\x86\x29\xe7\x48\xee\xd0\x97\xac\x40\x24\xe2\xbf\x25\x5d\x70\x41\x1f\x87\x37\x39\x48\xcf\x8e\x8a\xa7\xef\xfa\x2b\x0a\xb4\x7d\x51\x66\x09\x1e\x1a\xed\xec\x60\x56\x8b\x15\x5b\xd9\xc2\x7b\xc5\x5f\x3e\xce\x35\xf8\x3d\x63\x6d\xbc\xd5\xab\xf4\x85\x3a\x05\x1d\xb9\x4d\x50\x45" in
  let test1_bBytes = Bytes.of_string
      "\xd3\x51\x9b\xd8\x6e\xdf\x5d\xbe\x9c\x64\xa3\x78\x17\x13\xdd\x04\x9b\x74\x7f\x56\x51\xfd\x91\x8c\xce\x8a\x9b\x80\xb6\xd6\xa2\xfb\x6a\xab\x33\x4a\xb5\x69\xa8\x9b\x58\x98\x2e\x0a\xae\x37\x30\x90\x29\x9f\xa2\x27\xf9\x65\x2b\x80\x2d\x23\xee\x5c\xa6\x82\x4c\x43\x3d\x01\xd4\x0b\xb0\x47\x3b\x16\x19\x0a\x8b\xfb\x13\x7c\x0a\x70\x4b\x4f\x49\xb4\x50\x15\xbf\xbe\xe1\xf6\x70\x44\x6f\x07\x59\x52\x59\xd7\x0c\x7d\x79\xae\x95\xf9\xb2\x54\x3b\x01\x62\xeb\xb7\x63\xeb\xb8\x1c\x4b\x6e\xdf\xf9\xd1\x97\xde\xde\x1d\xbe\x57\xe4\x04\x66\xd1\x56\xd4\xdf\xd5\xd7\x63\x4c\x45\x53\x4f\xb2\xbb\xbd\x1b\xf2\x57\x81\x7a\x17\x3c\x07\x95\xfd\xbc\xc5\x33\x97\x6f\x4a\x0d\x04\x16\x0f\x29\x9a\xf5\xdc\x27\x2a\x81\x4b\x36\xd5\xba\xe5\x11\x6b\x95\x42\x17\x8f\x1d\x55\x4c\xab\x7a\x64\x53\x03\x54\x82\xb9\x81\xad\xd4\xbd\x8f\xfd\x5d\x50\x08\x39\xb2\x3e\x30\xeb\xd3\xf3\x86\x8f\x07\x58\x4c\xbd\x12\xba\x08\x93\x25\x98\x28\x60\xf6\x9f\x2b\xdc\x70\x77\xb6\xc6\x0f\x58\xa2\x27\x28\x23\x37\x9e\x10\x23\x70\x41\x65\xf7\xc1\x4f\x64\xa1\x8f\xd5\xb2\x45\xa1\x81\x49\xb7\xed\xa3\x38\x5a\x56\xba\x9e\x79\x50\x2a\x27\xbf\x13\x86\x5c\xde\x35\xbe\x15\xde\x03\xd0\x6a\xa6\xf0\x8b\x17\x2b\x7e\xeb\x4b\x73\xcb\xc1\x57\x01\x9c\x5d\x93\x35\x84\xa8\xd1\xad\xd6\x1b\x7d\xbc\xa3\xb2\x53\xca\x0c\xf9\x3d\xc9\xa8\xa3\xaa\xc2\xf5\x02\x27\x02\x2e\x69\x2f\x7b\x47\x67\x55\x66\x20\xcc\x92\x8d\x63\xe3\x10\x78\xc3\x60\xe2\xab\x4b\x71\xa9\x17\xe1\x9e\x7e\xb0\x93\x80\x48\x2e\x5b\x4e\xa8\x82\x02\x87\x1c\x2a\x29\xca\x6f\x66\xb2\xfe\x30\x4a\xf6\x09\x52\x0e\x4f\x81\xd6\x4c\x26\x76\x8b\xb8\x12\xa8\x66\x79\x36\x66\x11\xf4\xcf\x6e\x89\xe2\xbd\x1d\x9d\x7e\x28\x72\x9c\x7f\x0e\x4e\x31\x52\xd7\xad\x7f\x18\x6f\xa3\x2f\x01\xe1\x69\xff\x06\xa1\x20\x01\xbc\x17\x9d\xfd\x0d\xc9\x42\xcb\xab\xc5\x55\xf6\x7f\x5f\xd0\x43\xe0\xa3\x35\x43\x40\xfa\x49\x0d\x2f\x12\x33\x67\xbe\x92\x6e\xb3\xe1\xdf\xfe\x70\xc3\x15\x1c\x87\x45\x0f\x32\x17\xdc\x2a\xa0\xb5\xa7\x06\x9c\x5a\x17\xd5\x56\x14\xc9\x99\x41\x39\xf7\xb3\x7b\x49\xe9\xfe\x78\x0a\xf6\x5a\x0e\x89\xe2\xe5\x8f\xea\xaf\xfe\x16\x3b\xc9\xd1\x9e\xaf\xd9\xcd\x29\xb0\xef\x3c\xef\x3d\x01" in
  let test1_resByt = Bytes.of_string
      "\xba\x8b\x73\x49\xf4\x8d\xa7\xe7\x5f\x26\xef\x37\x13\x66\x0d\x8f\xd6\xcc\x51\x82\x2c\x5e\x68\xa0\xfe\x24\xc5\xd6\x28\x40\xb0\x0d\xde\x5b\xa9\xb9\xd2\xa2\xe6\xb1\x80\xaf\x6c\xf5\x52\x2c\xd7\x1a\x89\xf2\x0e\x0a\x47\x10\xd1\xb7\x67\x5e\x34\x38\x0a\x34\xa3\xdf\x78\x24\x7b\x1c\xc2\xb1\x60\x1b\x5d\xb1\x94\x6a\xed\x7e\x38\x40\x2d\x9d\xa1\xcb\xfb\x66\x71\x5b\x7f\x17\x46\x80\x0b\x6b\xc3\xed\x90\x0c\xe2\xc1\x70\x49\xf1\x66\x0d\x96\x97\x63\xf8\xec\x38\x28\x6d\xda\xd8\x37\xf7\x43\xb7\x76\x41\xe5\x19\x1b\x31\xfa\x19\x19\x27\xa4\xb5\xe1\xed\x3e\x51\x26\x93\x90\x98\xd8\x32\xb0\xf2\xda\x6b\x97\xc4\x7b\x3d\x8e\xcb\x87\x78\x56\xfe\x6d\x86\x5a\x2c\x8b\x56\xf3\xfa\xe7\x66\xb6\xd6\x62\x86\x65\xb8\x3f\xdf\x80\x63\xec\x25\x20\xaf\xf7\x45\xdc\x6a\x4d\x5c\x68\x07\x4b\xb7\xa1\xce\xac\x17\x23\x0b\x00\xc9\x87\x67\x41\x88\x34\x13\x58\x81\x9b\x26\x5e\xee\xac\x6c\x79\x2c\xf7\x66\x3e\x4f\x3f\x53\xd7\x75\x64\xaf\xee\x42\x38\xcd\x9d\x61\xcd\x34\x7c\xa3\xd4\xa0\x95\xac\xac\x40\x5f\xbe\x27\x98\xc3\x1f\xcc\x62\x2e\x43\x4c\xa9\xf8\x93\x86\xcc\x64\xac\xb6\x84\xa9\xb8\x8f\xbd\xd2\x25\xa6\x86\x55\x79\xd7\x2d\x50\x3c\x84\xdd\x95\xcd\x5f\x89\xad\xf9\xd8\x01\x8f\x5b\xac\x89\xf5\xc3\xcc\x31\x79\x52\xf0\xfe\xc0\x7b\xd3\x65\xb5\xe1\xe1\x44\xa7\xb0\xc6\xd1\x98\xae\x27\x26\x65\x1e\x55\x9d\x1b\xa4\x5f\x75\x22\xba\xa6\xb4\xd1\xa1\x99\x64\xae\x74\xfb\x41\x34\x53\x54\x4e\x09\xcd\xde\x3f\x50\x8f\xa5\xf4\xba\x59\x01\x9a\xb9\xdb\x16\x37\x6d\x35\x8d\x3d\x26\x5e\xa5\x42\x8c\x42\xa4\x61\x15\x60\x6d\x50\x97\xe3\xc4\xc8\x29\x13\x3b\x8e\xf3\x74\xfc\x79\xc5\x65\x40\xb3\xae\xec\x4a\x37\x0e\x52\x86\x39\xdb\x69\x15\x39\x64\xea\x83\x14\x67\xe9\x7d\x51\xd6\xa2\x5e\x17\x3b\xae\xec\x30\x23\xaa\x7b\x24\x13\x53\xcd\xbc\x6c\xed\xe2\x34\xd1\xda\xd9\xd0\xe4\x1f\xc5\x31\xb0\x0f\xdb\x23\x92\x88\xe7\x40\x2e\x42\xc3\xd4\x31\x73\x51\xac\x1f\x11\xcc\x3e\x8f\x26\x4f\xed\x4f\x3e\x7d\x90\xa2\x7a\x77\xb2\x0a\x6e\xc5\x2e\x39\x8f\x37\x8e\xf4\x50\x62\xfc\x2d\x25\x70\x40\x65\x15\x3f\x87\x9d\x4b\x49\x42\xc1\x85\x96\xfd\xd9\x06\x7b\x83\xb9\x75\xbe\x1b\xd4\x02\xc2\xdb\x1d\x73\x2b\x76\xc2\x8f\xa8\x9b\x1f" in
  let test1_aBytes = Bytes.of_string
      "\x21\x6b\x8d\xa5\x2a\xa5\x72\x85\x7a\xf1\x2b\xaa\x25\x56\x40\xf9\xb6\xaa\x0b\x3b\x22\x55\xe7\x30\xc1\x16\x36\x1a\xde\xc8\xa5\xc5\xd0\xdc\xc5\x29\x16\x2e\x29\x84\xd6\x9c\x9a\x40\x65\xb2\x1d\xb8\x3b\x79\xa8\x1a\x8d\x4f\xd7\x0b\x2c\xdc\x3d\x3a\xe9\xc7\x83\x3a\xd4\x9a\x26\x39\xa5\xb8\x2b\x43\x72\xd9\xd0\x39\xb6\xe6\xfc\xad\xf7\x05\x3b\x5d\xad\xa4\x10\x4a\x23\xae\x08\x16\xcd\x0a\x47\x01\xe2\x58\x17\x4a\x74\xc9\xb8\x43\x21\xab\x5e\xcd\xb1\x9e\x0c\x5a\xb3\xa6\x25\xd7\x2c\xb6\x6f\x29\xaa\x8a\xac\x3e\x43\x3e\xa4\xb9\x0d\x0d\x19\x92\x57\x61\xc7\xc3\x09\x30\x9a\xa5\xb6\xb5\x12\x6b\x83\xa7\xff\x0e\x5d\xf4\xd0\xfc\xba\xe9\x49\xaf\xa8\x17\xa9\xb4\x34\x09\x88\x4d\x5e\xd9\x50\x32\x96\xaa\x4d\xe9\xd7\x94\x60\x2a\xe4\x7d\xdb\x68\x34\x4b\x81\xcd\x0e\x7b\xf8\xac\x7c\xee\xdd\xa2\x86\xa5\x67\x3b\xa1\xba\x2d\xbe\x44\x61\xec\xbf\x67\xd0\x4b\xdb\x0e\x5b\xea\x2e\x0a\xac\xe1\x35\x8d\x5a\xab\xce\x28\xeb\xf3\x3a\x4f\x3a\x35\x47\xb6\xe2\xa6\xd9\x15\x62\x40\xfb\x4f\x05\xa4\x05\x38\xd7\xb5\x82\xcb\x64\x97\xad\xde\x17\x81\x76\xb5\x0a\xab\xee\x12\x07\x1a\xc7\x80\xf8\xfe\x2f\x85\x8f\xf1\x75\x33\xce\xe5\x6e\x4f\x46\x2b\xa4\x44\x6a\x3c\x20\x88\x89\x64\x04\xdd\x6f\x45\xfe\xcf\xdf\x6b\xa4\x4d\x2b\x34\xde\x1a\x62\x89\xc6\x36\x79\x4d\xd1\xd0\xa4\x9d\xb6\x3d\x1d\x75\x98\xa9\x81\x72\xf6\x5e\x6d\x65\xf7\xcc\xfa\x07\x9e\x9f\x66\x48\xd4\x11\x0d\x7d\xd2\xe0\xeb\x94\x84\x5e\x55\x24\x4f\xbb\x71\xb2\x49\x14\x63\x7e\xa3\xbd\xa4\x10\xb3\xc7\x56\xe1\x82\x5e\x21\xee\xb9\x9c\x3d\x6d\x70\x67\xcd\x23\x79\xf1\x42\x34\xf9\x01\xe5\xb5\x1e\xa9\x91\xda\x7f\xbe\x8d\xfb\x0b\x21\x99\x42\xae\xae\x7b\xe8\xfc\x21\x6c\xaa\x4f\xc6\x73\xe2\x86\x72\xd6\xb7\xc1\x0e\xac\x58\x74\x19\x3f\xcb\x20\x5f\xc7\xcd\x7e\x47\x63\x55\xdc\x88\x2b\xa8\xac\x51\xe4\x12\x88\xdb\xf7\x26\x00\x59\xda\x27\x6f\x5d\x90\x37\x46\x8b\x5f\x51\xf6\x06\xb6\xbc\xf5\x47\xa0\xf5\x59\xe5\x49\xf0\xad\xf4\x7c\x6f\x71\x05\xc1\x83\x9f\x10\x93\x51\x39\x91\x93\x85\x18\x2f\xfb\x1e\x44\x11\x91\x5e\x82\x6c\xbe\x45\xfe\xa0\x95\x11\x41\x82\x4c\x5a\x97\xcc\x73\xef\xf1\xc1\x00\xb1\x20\x8f\x3d\xdc\xa9\x97\x34\x39\x78\xf9\x16\x61\xbc" in

  let a = Bignum4096.from_bytes ~buf:test1_aBytes in
  let n = Bignum4096.from_bytes ~buf:test1_nBytes in
  let b = Bignum4096.from_bytes ~buf:test1_bBytes in

  match Bignum4096.mod_exp_raw ~n ~a ~b with
  | Some res ->
      let res_bytes = Bignum4096.to_bytes ~bn:res in
      if res_bytes = test1_resByt then
        test_result Success ""
      else
        test_result Failure ""
  | None ->
    test_result Failure ""

let _ =
  test_bignum256 ();
  test_bignum4096 ()
